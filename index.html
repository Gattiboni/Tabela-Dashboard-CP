<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Tabela Detalhamento</title>
  <link href="https://unpkg.com/tabulator-tables@5.4.4/dist/css/tabulator.min.css" rel="stylesheet">
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; background: #faf9f6; }
    #scrollTopTab { overflow-x: auto; width: 100%; height: 16px; margin-bottom: 4px; background: #faf9f6; }
    #scrollSyncTab { height: 1px; }
    #tabela { margin-top: 0px; }
    .tabulator .tabulator-group {
      background: #e3e6ed;
      font-weight: bold;
    }
    .linha-totais {
      background: #f6e6b3 !important;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>Tabela Detalhamento</h2>
  <div id="scrollTopTab">
    <div id="scrollSyncTab" style="width: 3000px; height: 1px;"></div>
  </div>
  <div id="tabela"></div>

  <script src="https://unpkg.com/tabulator-tables@5.4.4/dist/js/tabulator.min.js"></script>
  <script>
    // Exemplo de dados e colunas (substitua pelo seu contexto real, Appsmith envia via postMessage)
    let yourData = [];    // Inicial vazio
    let yourColumns = []; // Inicial vazio

    // Inicialização básica (será refeito via postMessage, pode sobrescrever)
    const table = new Tabulator("#tabela", {
      data: yourData,
      columns: yourColumns,
      layout: "fitDataStretch",
      height: "auto",
      placeholder: "Nenhum dado encontrado.",
      groupBy: "Classificação",
      groupStartOpen: true,
      groupHeader: function(value, count, data) {
        return value ? value + " (" + count + ")" : "";
      },
      rowFormatter: function(row) {
        const data = row.getData();
        if (data["__isTotal"]) {
          row.getElement().classList.add("linha-totais");
        }
      }
    });

    // Referências DOM (depois que Tabulator existir!)
    const scrollTopTab = document.getElementById("scrollTopTab");
    const scrollSyncTab = document.getElementById("scrollSyncTab");
    let tabelaHolder = null;

    // --- Função: Atualiza largura do scroll fake para igualar à tabela ---
    function updateScrollWidth() {
      tabelaHolder = table.element.querySelector(".tabulator-tableholder");
      if (tabelaHolder && scrollSyncTab) {
        scrollSyncTab.style.width = `${tabelaHolder.scrollWidth}px`;
      }
    }

    // --- Sincroniza scrolls (tabela <-> barra fake superior) ---
    function syncFakeToTable() {
      if (tabelaHolder) {
        tabelaHolder.scrollLeft = scrollTopTab.scrollLeft;
      }
    }
    function syncTableToFake(left) {
      scrollTopTab.removeEventListener("scroll", syncFakeToTable);
      scrollTopTab.scrollLeft = left;
      scrollTopTab.addEventListener("scroll", syncFakeToTable);
    }

    // --- Evento: Scroll real movimenta fake
    table.on("scrollHorizontal", syncTableToFake);

    // --- Evento: Scroll fake movimenta real
    scrollTopTab.addEventListener("scroll", syncFakeToTable);

    // --- Resize e rebuild: atualiza largura da barra fake
    table.on("dataLoaded", updateScrollWidth);
    table.on("renderComplete", updateScrollWidth);
    table.on("tableBuilt", updateScrollWidth);
    window.addEventListener('resize', updateScrollWidth);

    // --- postMessage: atualiza dados da tabela e barra fake ---
    window.addEventListener("message", function(event) {
      let dados = null;
      if (event.data && typeof event.data === "string") {
        try { dados = JSON.parse(event.data); } catch(e) {}
      } else if (event.data && Array.isArray(event.data)) {
        dados = event.data;
      }
      if (dados && Array.isArray(dados)) {
        // Atualiza tabela
        table.replaceData(dados).then(() => {
          updateScrollWidth();
          if (tabelaHolder) tabelaHolder.scrollLeft = 0;
          scrollTopTab.scrollLeft = 0;
        });
      }
    }, false);

    // --- Inicial: deixa barra fake correta (se tabela vier vazia) ---
    setTimeout(updateScrollWidth, 700);
  </script>
</body>
</html>
