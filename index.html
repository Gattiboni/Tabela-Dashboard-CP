<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Tabela Financeira (Tabulator)</title>
  <link href="https://unpkg.com/tabulator-tables@5.4.4/dist/css/tabulator.min.css" rel="stylesheet">
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; }
    #tabela { margin-top: 20px; }
  </style>
</head>
<body>
  <h2>Tabela Financeira (Tabulator)</h2>
  <div id="tabela"></div>

  <script src="https://unpkg.com/tabulator-tables@5.4.4/dist/js/tabulator.min.js"></script>
  <script>
    // Função para desenhar a tabela
    function drawTable(dados) {
      if (!dados || !Array.isArray(dados) || dados.length === 0) return;

      // Gera colunas dinâmicas baseado nas chaves do primeiro objeto
      const columns = Object.keys(dados[0]).map(key => {
        if (key === "expandCol") {
          return { title: "+", field: key, width: 40, hozAlign: "center", headerSort: false };
        }
        // Colunas de datas ficam mais estreitas
        if (key.match(/^\d{2}\/\d{2}/)) {
          return { title: key, field: key, width: 85, hozAlign: "center" };
        }
        // Demais colunas
        return { title: key, field: key, width: 150 };
      });

      // Destroi tabela antiga se houver (para atualização dinâmica)
      if (window.table) {
        window.table.setData([]); // Limpa dados
        window.table.destroy();
      }

      // Cria tabela Tabulator
      window.table = new Tabulator("#tabela", {
        data: dados,
        columns: columns,
        layout: "fitDataStretch",
        movableColumns: true,
        resizableRows: false,
        height: "auto",
        placeholder: "Nenhum dado encontrado.",
        langs: {
          "pt-br": {
            "columns": {},
            "data": { "loading": "Carregando...", "error": "Erro nos dados!" }
          }
        }
      });
      window.table.setLocale("pt-br");
    }

    // Inicializa com dados vazios (opcional)
    drawTable([]);

    // Recebe dados via postMessage (do Appsmith)
    window.addEventListener("message", function(event) {
      try {
        // Se quiser restringir, valide event.origin
        // if(event.origin !== "https://seu-appsmith.com") return;
        let data = typeof event.data === "string" ? JSON.parse(event.data) : event.data;
        // Espera um array de objetos como o do Appsmith
        if (Array.isArray(data)) {
          drawTable(data);
        }
      } catch(e) {
        console.error("Erro ao processar dados recebidos:", e);
      }
    }, false);
  </script>
</body>
</html>
